{
  if (!isRunningState.get()) {
    throw new RuntimeException("IllegalState: Cannot borrow when resource pool is closing down.");
  }
  long startTime=System.currentTimeMillis();
  Resources<V> resources=resourcesMap.get(key);
  if (resources == null) {
    resources=new Resources<V>(config.getDefaultPoolSize());
    Resources<V> prev=resourcesMap.putIfAbsent(key,resources);
    if (prev != null)     resources=prev;
  }
  V resource=getResource(key,resources,config.getBorrowTimeout(),config.getReturnTimeoutUnit());
  while (!objectFactory.validate(key,resource)) {
    cleanDestroyResource(key,resources,resource);
    resource=getResource(key,resources,computeNewTimeout(startTime,config.getBorrowTimeout(),config.getBorrowTimeoutUnit()),config.getBorrowTimeoutUnit());
  }
  return objectFactory.activate(key,resource);
}
