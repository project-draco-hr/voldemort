{
synchronized (lock) {
    if (useOneEnvPerStore) {
      if (environments.containsKey(storeName))       return environments.get(storeName);
      File bdbDir=new File(bdbMasterDir,storeName);
      if (!bdbDir.exists()) {
        logger.info("Creating BDB data directory '" + bdbDir.getAbsolutePath() + "' for store'"+ storeName+ "'.");
        bdbDir.mkdirs();
      }
      Environment environment=new Environment(bdbDir,environmentConfig);
      environments.put(storeName,environment);
      return environment;
    }
 else {
      if (!environments.isEmpty())       return environments.get(SHARED_ENV_KEY);
      File bdbDir=new File(bdbMasterDir);
      if (!bdbDir.exists()) {
        logger.info("Creating BDB data directory '" + bdbDir.getAbsolutePath() + "'.");
        bdbDir.mkdirs();
      }
      Environment environment=new Environment(bdbDir,environmentConfig);
      environments.put(SHARED_ENV_KEY,environment);
      return environment;
    }
  }
}
