{
  try {
    DataInputStream inputStream=new DataInputStream(new BufferedInputStream(socket.getInputStream(),64000));
    DataOutputStream outputStream=new DataOutputStream(new BufferedOutputStream(socket.getOutputStream(),64000));
    RequestFormatType protocol=negotiateProtocol(inputStream,outputStream);
    RequestHandler handler=handlerFactory.getRequestHandler(protocol);
    logger.info("Client " + socket.getRemoteSocketAddress() + " connected successfully with protocol "+ protocol.getCode());
    while (!isInterrupted()) {
      handler.handleRequest(inputStream,outputStream);
      outputStream.flush();
    }
  }
 catch (  EOFException e) {
    logger.info("Client " + socket.getRemoteSocketAddress() + " disconnected.");
  }
catch (  IOException e) {
    logger.error(e);
  }
 finally {
    try {
      socket.close();
    }
 catch (    Exception e) {
      logger.error("Error while closing socket",e);
    }
  }
}
