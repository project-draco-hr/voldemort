{
  try {
    while (true) {
      if (Thread.currentThread().isInterrupted()) {
        if (logger.isInfoEnabled())         logger.info("Interrupted");
        break;
      }
      processSockets();
      try {
        int selected=selector.select();
        if (selected > 0) {
          Iterator<SelectionKey> i=selector.selectedKeys().iterator();
          while (i.hasNext()) {
            SelectionKey selectionKey=i.next();
            i.remove();
            if (selectionKey.isReadable() || selectionKey.isWritable()) {
              Runnable worker=(Runnable)selectionKey.attachment();
              worker.run();
            }
          }
        }
      }
 catch (      Throwable t) {
        if (logger.isEnabledFor(Level.ERROR))         logger.error(t.getMessage(),t);
      }
    }
  }
 catch (  Throwable t) {
    if (logger.isEnabledFor(Level.ERROR))     logger.error(t.getMessage(),t);
  }
 finally {
    try {
      selector.close();
    }
 catch (    Exception e) {
      if (logger.isEnabledFor(Level.ERROR))       logger.error(e.getMessage(),e);
    }
  }
}
