{
  int currentNumNodes=currentCluster.getNumberOfNodes();
  int targetNumNodes=targetCluster.getNumberOfNodes();
  List<Integer> newNodeIds=Lists.newArrayList();
  List<Integer> donorNodeIds=Lists.newArrayList();
  List<Node> allNodes=Lists.newArrayList();
  HashMap<Integer,Integer> numPartitionsPerZone=Maps.newHashMap();
  HashMap<Integer,Integer> numNodesPerZone=Maps.newHashMap();
  HashMap<Integer,Integer> numDonorNodesPerZone=Maps.newHashMap();
  HashMap<Integer,Integer> numStealerNodesPerZone=Maps.newHashMap();
  for (  Node node : targetCluster.getNodes()) {
    if (node.getPartitionIds().isEmpty()) {
      newNodeIds.add(node.getId());
      if (numStealerNodesPerZone.containsKey(node.getZoneId())) {
        int currentNumStealerNodesInZone=numNodesPerZone.get(node.getZoneId());
        currentNumStealerNodesInZone+=1;
        numStealerNodesPerZone.put(node.getZoneId(),currentNumStealerNodesInZone);
      }
 else {
        numStealerNodesPerZone.put(node.getZoneId(),1);
      }
    }
 else {
      donorNodeIds.add(node.getId());
      if (numDonorNodesPerZone.containsKey(node.getZoneId())) {
        int currentNumDonorNodesInZone=numNodesPerZone.get(node.getZoneId());
        currentNumDonorNodesInZone+=1;
        numDonorNodesPerZone.put(node.getZoneId(),currentNumDonorNodesInZone);
      }
 else {
        numDonorNodesPerZone.put(node.getZoneId(),1);
      }
    }
    allNodes.add(updateNode(node,Lists.newArrayList(node.getPartitionIds())));
    if (numPartitionsPerZone.containsKey(node.getZoneId())) {
      int currentNumPartitionsInZone=numPartitionsPerZone.get(node.getZoneId());
      currentNumPartitionsInZone+=node.getNumberOfPartitions();
      numPartitionsPerZone.put(node.getZoneId(),currentNumPartitionsInZone);
    }
 else {
      numPartitionsPerZone.put(node.getZoneId(),node.getNumberOfPartitions());
    }
    if (numNodesPerZone.containsKey(node.getZoneId())) {
      int currentNumNodesInZone=numNodesPerZone.get(node.getZoneId());
      currentNumNodesInZone+=1;
      numNodesPerZone.put(node.getZoneId(),currentNumNodesInZone);
    }
 else {
      numNodesPerZone.put(node.getZoneId(),1);
    }
  }
  System.out.println("numPartitionsPerZone");
  for (  int zone : numPartitionsPerZone.keySet()) {
    System.out.println(zone + " : " + numPartitionsPerZone.get(zone));
  }
  System.out.println("numNodesPerZone");
  for (  int zone : numNodesPerZone.keySet()) {
    System.out.println(zone + " : " + numNodesPerZone.get(zone));
  }
  System.out.println("numDonorNodesPerZone");
  for (  int zone : numDonorNodesPerZone.keySet()) {
    System.out.println(zone + " : " + numDonorNodesPerZone.get(zone));
  }
  System.out.println("numStealerNodesPerZone");
  for (  int zone : numStealerNodesPerZone.keySet()) {
    System.out.println(zone + " : " + numStealerNodesPerZone.get(zone));
  }
  Cluster returnCluster=updateCluster(targetCluster,allNodes);
  int totalPrimaryPartitionsMoved=0;
  if (currentNumNodes == targetNumNodes) {
    return Pair.create(returnCluster,totalPrimaryPartitionsMoved);
  }
  int donorIndexRotationOffset=0;
  int nextDonorIndexRotationOffset=0;
  for (  int newNodeId : newNodeIds) {
    Node newNode=targetCluster.getNodeById(newNodeId);
    int partitionsToSteal=(int)Math.floor(numPartitionsPerZone.get(newNode.getZoneId()) * 1.0 / numNodesPerZone.get(newNode.getZoneId()));
    donorIndexRotationOffset+=nextDonorIndexRotationOffset;
    if (partitionsToSteal * numNodesPerZone.get(newNode.getZoneId()) + (donorIndexRotationOffset % numStealerNodesPerZone.get(newNode.getZoneId())) + numDonorNodesPerZone.get(newNode.getZoneId()) < numPartitionsPerZone.get(newNode.getZoneId())) {
      partitionsToSteal++;
    }
    nextDonorIndexRotationOffset=partitionsToSteal;
    System.out.println("newNodeId (" + newNodeId + ") has partitionsToSteal of "+ partitionsToSteal);
    int nodesStolenFrom=0;
    for (int index=0; index < donorNodeIds.size(); index++) {
      int donorNodeId=donorNodeIds.get((index + donorIndexRotationOffset) % donorNodeIds.size());
      Node donorNode=currentCluster.getNodeById(donorNodeId);
      if (donorNode.getZoneId() != newNode.getZoneId()) {
        continue;
      }
      if (partitionsToSteal <= 0)       break;
      int partitionsToDonate=Math.max((int)Math.floor(partitionsToSteal / (numDonorNodesPerZone.get(newNode.getZoneId()) - nodesStolenFrom)),1);
      System.out.println("donorNodeId (" + donorNodeId + ") has partitionsToDonate of "+ partitionsToDonate);
      nodesStolenFrom++;
      if (returnCluster.getNodeById(donorNodeId).getNumberOfPartitions() <= partitionsToDonate) {
        System.out.println("donorNodeId (" + donorNodeId + ") cannot donate any more partitions because getNumberof Partitions ("+ returnCluster.getNodeById(donorNodeId).getNumberOfPartitions()+ ") is less than partitions to Donate ("+ partitionsToDonate+ ")");
        continue;
      }
      List<Integer> donorPartitions=Lists.newArrayList(returnCluster.getNodeById(donorNodeId).getPartitionIds());
      Collections.shuffle(donorPartitions,new Random(System.currentTimeMillis()));
      int partitionsDonated=0;
      for (      int donorPartition : donorPartitions) {
        if (partitionsDonated == partitionsToDonate)         break;
        Cluster intermediateCluster=createUpdatedCluster(returnCluster,newNodeId,Lists.newArrayList(donorPartition));
        if (RebalanceUtils.getCrossZoneMoves(intermediateCluster,new RebalanceClusterPlan(returnCluster,intermediateCluster,storeDefs,true)) == 0) {
          returnCluster=intermediateCluster;
          partitionsDonated++;
          totalPrimaryPartitionsMoved++;
        }
      }
      partitionsToSteal-=partitionsDonated;
    }
  }
  return Pair.create(returnCluster,totalPrimaryPartitionsMoved);
}
