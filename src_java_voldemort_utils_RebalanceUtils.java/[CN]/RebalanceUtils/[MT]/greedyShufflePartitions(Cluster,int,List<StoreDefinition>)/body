{
  List<Node> allNodes=Lists.newArrayList();
  Set<Integer> zoneIds=new HashSet<Integer>();
  for (  Node node : targetCluster.getNodes()) {
    allNodes.add(updateNode(node,Lists.newArrayList(node.getPartitionIds())));
    zoneIds.add(node.getZoneId());
  }
  Cluster returnCluster=updateCluster(targetCluster,allNodes);
  int totalPrimaryPartitionsMoved=0;
  double currentMaxMinRatio=analyzeBalance(returnCluster,storeDefs,false);
  for (int i=0; i < swapAttempts; i++) {
    for (    Integer zoneId : zoneIds) {
      System.out.println("Greedy swap attempt: zone " + zoneId + " , attempt "+ i);
      Pair<Cluster,Integer> shuffleResults=swapGreedyPartitionsWithinZone(returnCluster,zoneId,storeDefs);
      double nextMaxMinRatio=analyzeBalance(shuffleResults.getFirst(),storeDefs,false);
      if (nextMaxMinRatio == currentMaxMinRatio) {
        System.out.println("Not improving for zone: " + zoneId);
      }
 else {
        System.out.println("Swap improved max-min ratio: " + currentMaxMinRatio + " -> "+ nextMaxMinRatio+ " (swap attempt "+ i+ " in zone "+ zoneId+ ")");
        returnCluster=shuffleResults.getFirst();
        currentMaxMinRatio=nextMaxMinRatio;
        totalPrimaryPartitionsMoved+=shuffleResults.getSecond();
      }
    }
  }
  return Pair.create(returnCluster,totalPrimaryPartitionsMoved);
}
