{
  logger.debug("rebalancer run() called.");
  VoldemortState voldemortState;
  RebalancerState rebalancerState;
  metadataStore.readLock.lock();
  try {
    voldemortState=metadataStore.getServerState();
    rebalancerState=metadataStore.getRebalancerState();
  }
 catch (  Exception e) {
    logger.error("Error determining state",e);
    return;
  }
 finally {
    metadataStore.readLock.unlock();
  }
  if (VoldemortState.REBALANCING_MASTER_SERVER.equals(voldemortState)) {
    for (    RebalancePartitionsInfo stealInfo : rebalancerState.getAll()) {
      if (acquireRebalancingPermit(stealInfo.getDonorId())) {
        releaseRebalancingPermit(stealInfo.getDonorId());
        try {
          logger.warn("Rebalance server found incomplete rebalancing attempt, restarting rebalancing task " + stealInfo);
          if (stealInfo.getAttempt() < voldemortConfig.getMaxRebalancingAttempt()) {
            attemptRebalance(stealInfo);
          }
 else {
            logger.warn("Rebalancing for rebalancing task " + stealInfo + " failed multiple times, Aborting more trials.");
            metadataStore.cleanRebalancingState(stealInfo);
          }
        }
 catch (        Exception e) {
          logger.error("RebalanceService rebalancing attempt " + stealInfo + " failed with exception",e);
        }
      }
    }
  }
}
