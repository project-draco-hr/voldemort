{
  File testSourceDirectory=createTempDir();
  File testDestinationDirectory=testSourceDirectory;
  File indexFile=new File(testSourceDirectory,"0_0.index");
  byte[] indexBytes=TestUtils.randomBytes(VoldemortConfig.DEFAULT_BUFFER_SIZE * 3);
  FileUtils.writeByteArrayToFile(indexFile,indexBytes);
  final Path source=new Path(indexFile.getAbsolutePath());
  CheckSum fileCheckSumGenerator=CheckSum.getInstance(CheckSumType.MD5);
  fileCheckSumGenerator.update(indexBytes);
  byte[] checksumCalculated=calculateCheckSumForFile(source);
  HdfsFetcher fetcher=new HdfsFetcher();
  Configuration config=new Configuration();
  FileSystem fs=source.getFileSystem(config);
  FileSystem spyfs=Mockito.spy(fs);
  CopyStats stats=new CopyStats(testSourceDirectory.getAbsolutePath(),sizeOfPath(fs,source));
  File destination=new File(testDestinationDirectory.getAbsolutePath() + "1");
  File copyLocation=new File(destination,"0_0.index");
  FSDataInputStream input=null;
  input=fs.open(source);
  FSDataInputStream spyinput=Mockito.spy(input);
  Mockito.doAnswer(Mockito.CALLS_REAL_METHODS).doThrow(new EofException()).when(spyinput).read();
  Mockito.doReturn(spyinput).doReturn(input).when(spyfs).open(source);
  Object[] params={spyfs,source,copyLocation,stats,CheckSumType.MD5};
  CheckSum ckSum=(CheckSum)this.invokePrivateMethod(fetcher,"copyFileWithCheckSum",params);
  assertEquals(Arrays.equals(ckSum.getCheckSum(),checksumCalculated),true);
}
