{
  long startNs=System.nanoTime();
  if (request == null) {
    int size=0;
    try {
      size=inputStream.readInt();
    }
 catch (    EOFException e) {
      if (logger.isTraceEnabled())       logger.trace("Incomplete read for message size");
      if (streamStats != null)       streamStats.reportNetworkTime(Operation.UPDATE_ENTRIES,Utils.elapsedTimeNs(startNs,System.nanoTime()));
      return StreamRequestHandlerState.INCOMPLETE_READ;
    }
    if (size == -1) {
      long totalTime=(System.currentTimeMillis() - startTime) / 1000;
      logger.info("Update entries successfully updated " + counter + " entries for store '"+ storageEngine.getName()+ "' in "+ totalTime+ " s");
      writeBufferedValsToStorage();
      if (logger.isTraceEnabled())       logger.trace("Message size -1, completed partition update");
      if (streamStats != null)       streamStats.reportNetworkTime(Operation.UPDATE_ENTRIES,Utils.elapsedTimeNs(startNs,System.nanoTime()));
      return StreamRequestHandlerState.COMPLETE;
    }
    if (logger.isTraceEnabled())     logger.trace("UpdatePartitionEntriesRequest message size: " + size);
    byte[] input=new byte[size];
    try {
      ByteUtils.read(inputStream,input);
    }
 catch (    EOFException e) {
      if (logger.isTraceEnabled())       logger.trace("Incomplete read for message");
      return StreamRequestHandlerState.INCOMPLETE_READ;
    }
 finally {
      if (streamStats != null)       streamStats.reportNetworkTime(Operation.UPDATE_ENTRIES,Utils.elapsedTimeNs(startNs,System.nanoTime()));
    }
    VAdminProto.UpdatePartitionEntriesRequest.Builder builder=VAdminProto.UpdatePartitionEntriesRequest.newBuilder();
    builder.mergeFrom(input);
    request=builder.build();
  }
  VAdminProto.PartitionEntry partitionEntry=request.getPartitionEntry();
  ByteArray key=ProtoUtils.decodeBytes(partitionEntry.getKey());
  Versioned<byte[]> value=ProtoUtils.decodeVersioned(partitionEntry.getVersioned());
  if (filter.accept(key,value)) {
    if (currBufferedKey != null && !key.equals(currBufferedKey)) {
      writeBufferedValsToStorage();
    }
    currBufferedKey=key;
    currBufferedVals.add(value);
  }
  request=null;
  return StreamRequestHandlerState.READING;
}
