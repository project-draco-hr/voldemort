{
  if (!isServerNormal()) {
    logger.error("Cannot run repair job since Voldemort server is not in normal state");
    return;
  }
  isRunning.set(true);
  ClosableIterator<ByteArray> iterator=null;
  Date startTime=new Date();
  logger.info("Started repair job at " + startTime);
  if (!acquireScanPermit()) {
    isRunning.set(false);
    return;
  }
  try {
    for (    StoreDefinition storeDef : metadataStore.getStoreDefList()) {
      if (isWritableStore(storeDef)) {
        StoreRoutingPlan routingPlan=new StoreRoutingPlan(metadataStore.getCluster(),storeDef);
        logger.info("Repairing store " + storeDef.getName());
        StorageEngine<ByteArray,byte[],byte[]> engine=storeRepo.getStorageEngine(storeDef.getName());
        iterator=engine.keys();
        long itemsScanned=0;
        long numDeletedKeys=0;
        while (iterator.hasNext()) {
          ByteArray key=iterator.next();
          if (!routingPlan.checkKeyBelongsToNode(key.get(),metadataStore.getNodeId())) {
            engine.delete(key,null);
            numDeletedKeys=this.numKeysUpdatedThisRun.incrementAndGet();
          }
          itemsScanned=this.numKeysScannedThisRun.incrementAndGet();
          throttler.maybeThrottle(Ints.checkedCast(itemsScanned));
          if (itemsScanned % STAT_RECORDS_INTERVAL == 0) {
            logger.info("#Scanned:" + itemsScanned + " #Deleted:"+ numDeletedKeys);
          }
        }
        closeIterator(iterator);
        logger.info("Completed store " + storeDef.getName() + " #Scanned:"+ itemsScanned+ " #Deleted:"+ numDeletedKeys);
      }
    }
  }
 catch (  Exception e) {
    logger.error("Error running RepairJob.. ",e);
  }
 finally {
    closeIterator(iterator);
    this.scanPermits.release(this.getClass().getCanonicalName());
    resetStats();
    logger.info("Completed repair job started at " + startTime);
    isRunning.set(false);
  }
}
