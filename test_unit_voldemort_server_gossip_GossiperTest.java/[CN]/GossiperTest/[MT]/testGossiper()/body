{
  int portIdx=0;
  int ports[]=new int[3 * (cluster.getNumberOfNodes() + 1)];
  for (  Node node : cluster.getNodes()) {
    ports[portIdx++]=node.getHttpPort();
    ports[portIdx++]=node.getSocketPort();
    ports[portIdx++]=node.getAdminPort();
  }
  int[] freeports=ServerTestUtils.findFreePorts(3);
  ports[portIdx++]=freeports[0];
  ports[portIdx++]=freeports[1];
  ports[portIdx]=freeports[2];
  Cluster newCluster=ServerTestUtils.getLocalCluster(cluster.getNumberOfNodes() + 1,ports,new int[][]{{0,1,2},{3,4,5},{6,7,8},{9,10,11}});
  VoldemortServer newServer=ServerTestUtils.startVoldemortServer(ServerTestUtils.createServerConfig(3,TestUtils.createTempDir().getAbsolutePath(),null,storesXmlfile),newCluster);
  servers.add(newServer);
  try {
    Thread.sleep(500);
  }
 catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
  }
  AdminClient localAdminClient=getAdminClient(newCluster,newServer.getVoldemortConfig());
  Versioned<String> versionedClusterXML=localAdminClient.getRemoteMetadata(3,MetadataStore.CLUSTER_KEY);
  Version version=versionedClusterXML.getVersion();
  ((VectorClock)version).incrementVersion(3,((VectorClock)version).getTimestamp() + 1);
  ((VectorClock)version).incrementVersion(0,((VectorClock)version).getTimestamp() + 1);
  localAdminClient.updateRemoteMetadata(0,MetadataStore.CLUSTER_KEY,versionedClusterXML);
  localAdminClient.updateRemoteMetadata(3,MetadataStore.CLUSTER_KEY,versionedClusterXML);
  try {
    Thread.sleep(500);
  }
 catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
  }
  ExecutorService executorService=Executors.newFixedThreadPool(newCluster.getNumberOfNodes() + 1);
  List<Gossiper> gossipers=new ArrayList<Gossiper>(newCluster.getNumberOfNodes());
  for (  VoldemortServer server : servers) {
    Gossiper gossiper=new Gossiper(server.getMetadataStore(),getAdminClient(server.getMetadataStore().getCluster(),server.getVoldemortConfig()),50);
    gossiper.start();
    executorService.submit(gossiper);
    gossipers.add(gossiper);
  }
  int serversSeen=0;
  try {
    Thread.sleep(1000);
    for (    VoldemortServer server : servers) {
      Cluster clusterAtServer=server.getMetadataStore().getCluster();
      int nodeId=server.getMetadataStore().getNodeId();
      assertEquals("server " + nodeId + " has heard "+ " the gossip about number of nodes",clusterAtServer.getNumberOfNodes(),newCluster.getNumberOfNodes());
      assertEquals("server " + nodeId + " has heard "+ " the gossip about partitions",clusterAtServer.getNodeById(nodeId).getPartitionIds(),newCluster.getNodeById(nodeId).getPartitionIds());
      serversSeen++;
    }
  }
 catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
  }
 finally {
    for (    Gossiper gossiper : gossipers)     gossiper.stop();
  }
  assertEquals("saw all servers",serversSeen,servers.size());
}
