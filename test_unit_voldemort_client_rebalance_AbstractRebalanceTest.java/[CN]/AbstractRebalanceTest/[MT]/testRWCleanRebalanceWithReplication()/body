{
  Cluster currentCluster=ServerTestUtils.getLocalCluster(3,new int[][]{{0,1},{2,3,6,7},{4,5}});
  Cluster targetCluster=RebalanceUtils.createUpdatedCluster(currentCluster,currentCluster.getNodeById(2),currentCluster.getNodeById(1),Lists.newArrayList(6,7));
  List<Integer> serverList=Arrays.asList(0,1,2);
  currentCluster=startServers(currentCluster,rwStoreDefFileWithReplication,serverList,null);
  targetCluster=updateCluster(targetCluster);
  RebalanceClientConfig config=new RebalanceClientConfig();
  config.setDeleteAfterRebalancingEnabled(false);
  RebalanceController rebalanceClient=new RebalanceController(getBootstrapUrl(currentCluster,0),config);
  try {
    populateData(currentCluster,rwStoreDefWithReplication,rebalanceClient.getAdminClient(),false);
    rebalanceAndCheck(currentCluster,targetCluster,Lists.newArrayList(rwStoreDefWithReplication),rebalanceClient,Arrays.asList(0,1,2));
    checkConsistentMetadata(targetCluster,serverList);
  }
  finally {
    stopServer(serverList);
  }
}
