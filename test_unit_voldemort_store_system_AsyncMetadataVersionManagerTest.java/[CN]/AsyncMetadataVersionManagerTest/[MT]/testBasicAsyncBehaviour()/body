{
  try {
    Callable<Void> rebootstrapCallback=new Callable<Void>(){
      public Void call() throws Exception {
        callback();
        return null;
      }
    }
;
    this.sysVersionStore.putSysStore(AsyncMetadataVersionManager.STORES_VERSION_KEY,100l);
    Thread.sleep(500);
    this.asyncCheckMetadata=new AsyncMetadataVersionManager(this.repository,rebootstrapCallback);
    scheduler.schedule(asyncCheckMetadata.getClass().getName(),asyncCheckMetadata,new Date(),500);
    int maxRetries=0;
    while (maxRetries < 3 && !asyncCheckMetadata.isActive) {
      Thread.sleep(500);
      maxRetries++;
    }
    this.newVersion=101;
    this.sysVersionStore.putSysStore(AsyncMetadataVersionManager.STORES_VERSION_KEY,this.newVersion);
    maxRetries=0;
    while (maxRetries < 3 && !callbackDone) {
      Thread.sleep(2000);
      maxRetries++;
    }
    assertEquals(this.updatedStoresVersion,this.newVersion);
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail("Failed to start the Metadata Version Manager : " + e.getMessage());
  }
}
