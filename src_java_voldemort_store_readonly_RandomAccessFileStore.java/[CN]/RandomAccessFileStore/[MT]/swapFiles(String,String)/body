{
  fileModificationLock.writeLock().lock();
  try {
    close();
    shiftBackups(".index");
    shiftBackups(".data");
    File firstIndexBackup=new File(storageDir,name + ".index.1");
    File firstDataBackup=new File(storageDir,name + ".data.1");
    boolean success=indexFile.getAbsoluteFile().renameTo(firstIndexBackup) && dataFile.getAbsoluteFile().renameTo(firstDataBackup);
    if (!success)     throw new VoldemortException("Error while renaming backups.");
    success=new File(newIndexFile).renameTo(indexFile) && new File(newDataFile).renameTo(dataFile);
    if (!success) {
      logger.error("Failure while copying in new data files, restoring from backup and aborting.");
      success=firstIndexBackup.renameTo(indexFile) && firstDataBackup.renameTo(dataFile);
      if (success) {
        logger.error("Restored from backup.");
        throw new VoldemortException("Failure while copying in new data files, but managed to restore from backup.");
      }
 else {
        logger.error("Rollback failed too.");
        throw new VoldemortException("Failure while copying in new data files, and restoration failed, everything is FUBAR.");
      }
    }
    open();
  }
  finally {
    fileModificationLock.writeLock().unlock();
  }
}
