{
  logger.info("Swapping index and data files for store '" + getName() + "':");
  logger.info("Locking all reads on '" + getName() + "':");
  fileModificationLock.writeLock().lock();
  try {
    close();
    logger.info("Renaming data and index files for '" + getName() + "':");
    shiftBackups(".index");
    shiftBackups(".data");
    File firstIndexBackup=new File(storageDir,name + ".index.1");
    File firstDataBackup=new File(storageDir,name + ".data.1");
    boolean success=indexFile.getAbsoluteFile().renameTo(firstIndexBackup) && dataFile.getAbsoluteFile().renameTo(firstDataBackup);
    if (!success)     throw new VoldemortException("Error while renaming backups.");
    logger.info("Setting primary data and index files for store '" + getName() + "'to "+ newDataFile+ " and "+ newIndexFile+ " respectively.");
    success=new File(newIndexFile).renameTo(indexFile) && new File(newDataFile).renameTo(dataFile);
    if (!success) {
      logger.error("Failure while copying in new data files, restoring from backup and aborting.");
      success=firstIndexBackup.renameTo(indexFile) && firstDataBackup.renameTo(dataFile);
      if (success) {
        logger.error("Restored from backup.");
        throw new VoldemortException("Failure while copying in new data files, but managed to restore from backup.");
      }
 else {
        logger.error("Rollback failed too.");
        throw new VoldemortException("Failure while copying in new data files, and restoration failed, everything is FUBAR.");
      }
    }
    open();
  }
  finally {
    logger.info("Swap operation completed on '" + getName() + "', releasing lock.");
    fileModificationLock.writeLock().unlock();
  }
}
