{
  FileChannel dataChannel=new FileInputStream(fileToStream).getChannel();
  VAdminProto.FileEntry response=VAdminProto.FileEntry.newBuilder().setFileName(fileToStream.getAbsolutePath()).setFileSizeBytes(dataChannel.size()).build();
  ProtoUtils.writeMessage(stream,response);
  throttler.maybeThrottle(response.getSerializedSize());
  WritableByteChannel channelOut=Channels.newChannel(stream);
  boolean completedFile=false;
  long chunkSize=0;
  for (long chunkStart=0; chunkStart < dataChannel.size() && !completedFile; chunkStart+=blockSize) {
    if (dataChannel.size() - chunkStart < blockSize) {
      chunkSize=dataChannel.size() - chunkStart;
      completedFile=true;
    }
 else {
      chunkSize=blockSize;
    }
    dataChannel.transferTo(chunkStart,chunkSize,channelOut);
    throttler.maybeThrottle((int)chunkSize);
  }
}
