{
  VAdminProto.UpdatePartitionEntriesRequest request=originalRequest;
  VAdminProto.UpdatePartitionEntriesResponse.Builder response=VAdminProto.UpdatePartitionEntriesResponse.newBuilder();
  boolean continueReading=true;
  try {
    String storeName=request.getStore();
    StorageEngine<ByteArray,byte[]> storageEngine=getStorageEngine(storeName);
    VoldemortFilter filter=(request.hasFilter()) ? getFilterFromRequest(request.getFilter()) : new DefaultVoldemortFilter();
    int counter=0;
    long startTime=System.currentTimeMillis();
    EventThrottler throttler=new EventThrottler(voldemortConfig.getStreamMaxWriteBytesPerSec());
    while (continueReading) {
      VAdminProto.PartitionEntry partitionEntry=request.getPartitionEntry();
      ByteArray key=ProtoUtils.decodeBytes(partitionEntry.getKey());
      Versioned<byte[]> value=ProtoUtils.decodeVersioned(partitionEntry.getVersioned());
      if (filter.accept(key,value)) {
        try {
          storageEngine.put(key,value);
        }
 catch (        ObsoleteVersionException e) {
          logger.debug("updateEntries (Streaming put) threw ObsoleteVersionException, Ignoring.");
        }
        if (throttler != null) {
          throttler.maybeThrottle(entrySize(key,value));
        }
      }
      counter++;
      if (0 == counter % 100000) {
        long totalTime=(System.currentTimeMillis() - startTime) / 1000;
        if (logger.isDebugEnabled())         logger.debug("updateEntries() updated " + counter + " entries for store:"+ storageEngine.getName()+ " in "+ totalTime+ " s");
      }
      int size=inputStream.readInt();
      if (size == -1)       continueReading=false;
 else {
        byte[] input=new byte[size];
        ByteUtils.read(inputStream,input);
        VAdminProto.UpdatePartitionEntriesRequest.Builder builder=VAdminProto.UpdatePartitionEntriesRequest.newBuilder();
        builder.mergeFrom(input);
        request=builder.build();
      }
    }
  }
 catch (  VoldemortException e) {
    response.setError(ProtoUtils.encodeError(errorCodeMapper,e));
    logger.error("handleUpdatePartitionEntries failed for request(" + request.toString() + ")",e);
  }
 finally {
    ProtoUtils.writeMessage(outputStream,response.build());
  }
}
