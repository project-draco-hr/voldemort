{
  VAdminProto.SwapStoresAndCleanStateResponse.Builder response=VAdminProto.SwapStoresAndCleanStateResponse.newBuilder();
  Map<String,String> storeToVersionDir=Maps.newHashMap();
  for (  ROStoreVersionDirMap currentStore : request.getRoStoreVersionsList()) {
    storeToVersionDir.put(currentStore.getStoreName(),currentStore.getStoreDir());
  }
  try {
    for (    String storeName : storeToVersionDir.keySet()) {
      logger.debug("Swapping " + storeName);
      swapStore(storeName,storeToVersionDir.get(storeName));
    }
  }
 catch (  VoldemortException e) {
    response.setError(ProtoUtils.encodeError(errorCodeMapper,e));
    logger.error("handleSwapStoresAndCleanState failed for request(" + request.toString() + ")",e);
  }
 finally {
    logger.debug("Cleaning rebalancer state");
    metadataStore.cleanAllRebalancingState();
    if (rebalancer.hasRebalancingPermit(metadataStore.getNodeId()))     rebalancer.releaseRebalancingPermit(metadataStore.getNodeId());
  }
  return response.build();
}
