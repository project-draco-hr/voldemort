{
  if (ec2RebalanceTestConfig.getInstanceCount() < template.getNumberOfNodes())   throw new IllegalStateException("instanceCount must be >= number of nodes in the cluster");
  Map<String,Integer> nodeIds=generateClusterDescriptor(hostNamePairs,template,ec2RebalanceTestConfig);
  List<Node> nodes=new ArrayList<Node>();
  for (  Map.Entry<String,Integer> entry : nodeIds.entrySet()) {
    String hostName=entry.getKey();
    int nodeId=entry.getValue();
    Node tmplNode=template.getNodeById(nodeId);
    Node node=new Node(nodeId,hostName,tmplNode.getHttpPort(),tmplNode.getSocketPort(),tmplNode.getAdminPort(),tmplNode.getPartitionIds());
    nodes.add(node);
    nodeIdsInv.put(nodeId,hostName);
    activeHostNames.add(hostName);
  }
  Cluster cluster=new Cluster(template.getName(),nodes);
  deploy(activeHostNames,ec2RebalanceTestConfig);
  startClusterAsync(activeHostNames,ec2RebalanceTestConfig,nodeIds);
  logger.info("Sleeping for ten seconds to let Voldemort start.");
  Thread.sleep(10000);
  return cluster;
}
