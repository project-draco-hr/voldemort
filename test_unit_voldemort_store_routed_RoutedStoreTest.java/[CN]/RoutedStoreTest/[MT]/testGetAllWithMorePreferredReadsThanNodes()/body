{
  cluster=VoldemortTestConstants.getTwoNodeCluster();
  StoreDefinition storeDef=ServerTestUtils.getStoreDef("test",2,2,1,2,2,RoutingStrategyType.CONSISTENT_STRATEGY);
  Map<Integer,Store<ByteArray,byte[]>> subStores=Maps.newHashMap();
  Map<Integer,NonblockingStore> nonblockingStores=new HashMap<Integer,NonblockingStore>();
  ExecutorService threadPool=Executors.newFixedThreadPool(1);
  int id1=Iterables.get(cluster.getNodes(),0).getId();
  int id2=Iterables.get(cluster.getNodes(),1).getId();
  subStores.put(id1,new InMemoryStorageEngine<ByteArray,byte[]>("test"));
  subStores.put(id2,new InMemoryStorageEngine<ByteArray,byte[]>("test"));
  nonblockingStores.put(id1,new ThreadPoolBasedNonblockingStoreImpl(threadPool,subStores.get(id1)));
  nonblockingStores.put(id2,new ThreadPoolBasedNonblockingStoreImpl(threadPool,subStores.get(id2)));
  setFailureDetector(subStores);
  RoutableStore routableStore=new NewRoutedStore("test",subStores,nonblockingStores,cluster,storeDef,true,threadPool,1000L,failureDetector);
  Store<ByteArray,byte[]> store=new InconsistencyResolvingStore<ByteArray,byte[]>(routableStore,new VectorClockInconsistencyResolver<byte[]>());
  store.put(aKey,Versioned.value(aValue));
  recordException(failureDetector,cluster.getNodes().iterator().next());
  Map<ByteArray,List<Versioned<byte[]>>> all=store.getAll(Arrays.asList(aKey));
  assertEquals(1,all.size());
  assertTrue(Arrays.equals(aValue,all.values().iterator().next().get(0).getValue()));
}
