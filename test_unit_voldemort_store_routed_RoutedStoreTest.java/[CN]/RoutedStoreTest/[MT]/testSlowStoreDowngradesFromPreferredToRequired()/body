{
  cluster=VoldemortTestConstants.getThreeNodeCluster();
  StoreDefinition storeDef=ServerTestUtils.getStoreDef("test",3,3,2,3,1,RoutingStrategyType.CONSISTENT_STRATEGY);
  int sleepTimeMs=500;
  Map<Integer,Store<ByteArray,byte[],byte[]>> subStores=Maps.newHashMap();
  for (  Node node : cluster.getNodes()) {
    Store<ByteArray,byte[],byte[]> store=new InMemoryStorageEngine<ByteArray,byte[],byte[]>("test");
    if (subStores.isEmpty()) {
      store=new SleepyStore<ByteArray,byte[],byte[]>(sleepTimeMs,store);
    }
    subStores.put(node.getId(),store);
  }
  setFailureDetector(subStores);
  routedStoreThreadPool=Executors.newFixedThreadPool(cluster.getNumberOfNodes());
  RoutedStoreFactory routedStoreFactory=new RoutedStoreFactory(isPipelineRoutedStoreEnabled,routedStoreThreadPool,new TimeoutConfig(10000L,false));
  RoutedStore routedStore=routedStoreFactory.create(cluster,storeDef,subStores,true,failureDetector);
  routedStore.put(aKey,Versioned.value(aValue),null);
  routedStoreFactory=new RoutedStoreFactory(isPipelineRoutedStoreEnabled,routedStoreThreadPool,new TimeoutConfig(sleepTimeMs / 2,false));
  routedStore=routedStoreFactory.create(cluster,storeDef,subStores,true,failureDetector);
  List<Versioned<byte[]>> versioneds=routedStore.get(aKey,null);
  assertEquals(2,versioneds.size());
}
