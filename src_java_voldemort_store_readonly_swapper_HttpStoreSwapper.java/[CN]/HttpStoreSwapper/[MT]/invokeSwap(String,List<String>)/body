{
  Map<Integer,String> previousDirs=new HashMap<Integer,String>();
  HashMap<Integer,Exception> exceptions=Maps.newHashMap();
  for (  final Node node : cluster.getNodes()) {
    HttpResponse httpResponse=null;
    try {
      String url=node.getHttpUrl() + "/" + readOnlyMgmtPath;
      HttpPost post=new HttpPost(url);
      HttpParams params=post.getParams();
      params.setParameter("operation","swap");
      String dir=fetchFiles.get(node.getId());
      logger.info("Attempting swap for node " + node.getId() + " dir = "+ dir);
      params.setParameter("dir",dir);
      params.setParameter("store",storeName);
      httpResponse=httpClient.execute(post);
      int responseCode=httpResponse.getStatusLine().getStatusCode();
      String previousDir=VoldemortIOUtils.toString(httpResponse.getEntity().getContent(),30000);
      if (responseCode != 200)       throw new VoldemortException("Swap request on node " + node.getId() + " ("+ url+ ") failed: "+ httpResponse.getStatusLine().getReasonPhrase());
      logger.info("Swap succeeded on node " + node.getId());
      previousDirs.put(node.getId(),previousDir);
    }
 catch (    Exception e) {
      exceptions.put(node.getId(),e);
      logger.error("Exception thrown during swap operation on node " + node.getId() + ": ",e);
    }
 finally {
      VoldemortIOUtils.closeQuietly(httpResponse,node.toString());
    }
  }
  if (!exceptions.isEmpty()) {
    if (rollbackFailedSwap) {
      for (      int successfulNodeId : previousDirs.keySet()) {
        HttpResponse httpResponse=null;
        try {
          String url=cluster.getNodeById(successfulNodeId).getHttpUrl() + "/" + readOnlyMgmtPath;
          HttpPost post=new HttpPost(url);
          HttpParams params=post.getParams();
          params.setParameter("operation","rollback");
          params.setParameter("store",storeName);
          params.setParameter("pushVersion",Long.toString(ReadOnlyUtils.getVersionId(new File(previousDirs.get(successfulNodeId)))));
          logger.info("Rolling back data on successful node " + successfulNodeId);
          httpResponse=httpClient.execute(post);
          int responseCode=httpResponse.getStatusLine().getStatusCode();
          String response=httpResponse.getStatusLine().getReasonPhrase();
          if (responseCode == 200) {
            logger.info("Rollback succeeded for node " + successfulNodeId);
          }
 else {
            throw new VoldemortException(response);
          }
        }
 catch (        Exception e) {
          logger.error("Exception thrown during rollback ( after swap ) operation on node " + successfulNodeId + " : ",e);
        }
 finally {
          VoldemortIOUtils.closeQuietly(httpResponse);
        }
      }
    }
    for (    int failedNodeId : exceptions.keySet()) {
      logger.error("Error on node " + failedNodeId + " during swap : ",exceptions.get(failedNodeId));
    }
    throw new VoldemortException("Exception during swaps on nodes " + Joiner.on(",").join(exceptions.keySet()) + " failed");
  }
}
