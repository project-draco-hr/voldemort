{
  byte[] keyBytes=keySerializer.toBytes(makeKey(key,value));
  byte[] valBytes=valueSerializer.toBytes(makeValue(key,value));
  if (keySerializerDefinition.hasCompression()) {
    keyBytes=keyCompressor.deflate(keyBytes);
  }
  if (valueSerializerDefinition.hasCompression()) {
    valBytes=valueCompressor.deflate(valBytes);
  }
  List<Integer> partitionList=routingStrategy.getPartitionList(keyBytes);
  Node[] partitionToNode=routingStrategy.getPartitionToNode();
  byte[] outputValue;
  BytesWritable outputKey;
  int offsetTillNow=2 * ByteUtils.SIZE_OF_INT;
  if (getSaveKeys()) {
    outputValue=new byte[valBytes.length + keyBytes.length + ByteUtils.SIZE_OF_BYTE+ 4 * ByteUtils.SIZE_OF_INT];
    offsetTillNow+=ByteUtils.SIZE_OF_BYTE;
    ByteUtils.writeInt(outputValue,keyBytes.length,offsetTillNow);
    offsetTillNow+=ByteUtils.SIZE_OF_INT;
    System.arraycopy(keyBytes,0,outputValue,offsetTillNow,keyBytes.length);
    offsetTillNow+=keyBytes.length;
    ByteUtils.writeInt(outputValue,valBytes.length,offsetTillNow);
    offsetTillNow+=ByteUtils.SIZE_OF_INT;
    System.arraycopy(valBytes,0,outputValue,offsetTillNow,valBytes.length);
    outputKey=new BytesWritable(ByteUtils.copy(md5er.digest(keyBytes),0,2 * ByteUtils.SIZE_OF_INT));
  }
 else {
    outputValue=new byte[valBytes.length + 2 * ByteUtils.SIZE_OF_INT];
    System.arraycopy(valBytes,0,outputValue,offsetTillNow,valBytes.length);
    outputKey=new BytesWritable(md5er.digest(keyBytes));
  }
  int replicaType=0;
  for (  Integer partition : partitionList) {
    ByteUtils.writeInt(outputValue,partitionToNode[partition].getId(),0);
    ByteUtils.writeInt(outputValue,partition,ByteUtils.SIZE_OF_INT);
    if (getSaveKeys()) {
      ByteUtils.writeBytes(outputValue,replicaType,2 * ByteUtils.SIZE_OF_INT,ByteUtils.SIZE_OF_BYTE);
    }
    BytesWritable outputVal=new BytesWritable(outputValue);
    output.collect(outputKey,outputVal);
    replicaType++;
  }
  md5er.reset();
}
