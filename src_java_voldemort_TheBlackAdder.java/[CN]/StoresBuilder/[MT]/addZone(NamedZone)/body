{
  LinkedList<StoreDefinition> newStores=new LinkedList<StoreDefinition>();
  for (  StoreDefinition store : stores) {
    int totalRep=0;
    HashMap<Integer,Integer> newZoneReps=new HashMap<Integer,Integer>();
    int repFactor=-1;
    boolean haveRepFactor=false;
    for (    Map.Entry<Integer,Integer> pair : store.getZoneReplicationFactor().entrySet()) {
      if (!haveRepFactor) {
        haveRepFactor=true;
        repFactor=pair.getValue();
      }
 else       if (repFactor != pair.getValue()) {
        throw new Exception("Store " + store.getName() + ": not all zones have equal replication factors");
      }
      newZoneReps.put(pair.getKey(),repFactor);
      totalRep+=repFactor;
    }
    if (!haveRepFactor)     throw new Exception("Store " + store.getName() + ": no replication factors");
    newZoneReps.put(nz.id,repFactor);
    totalRep+=repFactor;
    newStores.add(new StoreDefinitionBuilder(store).setReplicationFactor(totalRep).setZoneReplicationFactor(newZoneReps).build());
  }
  stores=newStores;
  return this;
}
