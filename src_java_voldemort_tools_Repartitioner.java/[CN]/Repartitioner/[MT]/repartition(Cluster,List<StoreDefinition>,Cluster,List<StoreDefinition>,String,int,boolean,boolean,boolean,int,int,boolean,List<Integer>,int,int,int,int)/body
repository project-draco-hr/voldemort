{
  PartitionBalance partitionBalance=new PartitionBalance(currentCluster,currentStoreDefs);
  RebalanceUtils.dumpAnalysisToFile(outputDir,RebalanceUtils.currentClusterFileName,partitionBalance);
  Cluster minCluster=interimCluster;
  double minUtility=Double.MAX_VALUE;
  for (int attempt=0; attempt < attempts; attempt++) {
    Cluster nextCluster=interimCluster;
    if (maxContiguousPartitionsPerZone > 0) {
      nextCluster=repeatedlyBalanceContiguousPartitionsPerZone(nextCluster,maxContiguousPartitionsPerZone);
    }
    if (!disableNodeBalancing) {
      nextCluster=balancePrimaryPartitions(nextCluster,!disableZoneBalancing);
    }
    if (enableRandomSwaps) {
      nextCluster=randomShufflePartitions(nextCluster,randomSwapAttempts,randomSwapSuccesses,finalStoreDefs);
    }
    if (enableGreedySwaps) {
      nextCluster=greedyShufflePartitions(nextCluster,greedySwapAttempts,greedySwapMaxPartitionsPerNode,greedySwapMaxPartitionsPerZone,new ArrayList<Integer>(interimCluster.getZoneIds()),finalStoreDefs);
    }
    RebalanceUtils.validateCurrentFinalCluster(currentCluster,nextCluster);
    System.out.println("-------------------------\n");
    partitionBalance=new PartitionBalance(nextCluster,finalStoreDefs);
    double currentUtility=partitionBalance.getUtility();
    System.out.println("Optimization number " + attempt + ": "+ currentUtility+ " max/min ratio");
    System.out.println("-------------------------\n");
    System.out.println(RebalanceUtils.analyzeInvalidMetadataRate(interimCluster,currentStoreDefs,nextCluster,currentStoreDefs));
    if (currentUtility <= minUtility) {
      minUtility=currentUtility;
      minCluster=nextCluster;
      RebalanceUtils.dumpClusterToFile(outputDir,RebalanceUtils.finalClusterFileName + attempt,minCluster);
      RebalanceUtils.dumpAnalysisToFile(outputDir,RebalanceUtils.finalClusterFileName + attempt,partitionBalance);
    }
    System.out.println("-------------------------\n");
  }
  System.out.println("\n==========================");
  System.out.println("Final distribution");
  partitionBalance=new PartitionBalance(minCluster,finalStoreDefs);
  System.out.println(partitionBalance);
  RebalanceUtils.dumpClusterToFile(outputDir,RebalanceUtils.finalClusterFileName,minCluster);
  RebalanceUtils.dumpAnalysisToFile(outputDir,RebalanceUtils.finalClusterFileName,partitionBalance);
  return minCluster;
}
