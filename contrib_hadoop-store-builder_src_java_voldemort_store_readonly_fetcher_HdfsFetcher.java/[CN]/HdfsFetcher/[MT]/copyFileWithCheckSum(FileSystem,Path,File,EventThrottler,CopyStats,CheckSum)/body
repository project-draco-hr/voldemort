{
  logger.info("Starting copy of " + source + " to "+ dest);
  FSDataInputStream input=null;
  OutputStream output=null;
  try {
    input=fs.open(source);
    output=new FileOutputStream(dest);
    byte[] buffer=new byte[bufferSize];
    while (true) {
      int read=input.read(buffer);
      if (read < 0) {
        break;
      }
 else       if (read < bufferSize) {
        buffer=ByteUtils.copy(buffer,0,read);
      }
      output.write(buffer);
      if (fileCheckSumGenerator != null)       fileCheckSumGenerator.update(buffer);
      if (throttler != null)       throttler.maybeThrottle(read);
      stats.recordBytes(read);
      if (stats.getBytesSinceLastReport() > REPORTING_INTERVAL_BYTES) {
        NumberFormat format=NumberFormat.getNumberInstance();
        format.setMaximumFractionDigits(2);
        logger.info(stats.getTotalBytesCopied() / (1024 * 1024) + " MB copied at " + format.format(stats.getBytesPerSecond() / (1024 * 1024)) + " MB/sec");
        if (this.status != null) {
          this.status.setStatus(stats.getTotalBytesCopied() / (1024 * 1024) + " MB copied at " + format.format(stats.getBytesPerSecond() / (1024 * 1024)) + " MB/sec");
        }
        stats.reset();
      }
    }
    logger.info("Completed copy of " + source + " to "+ dest);
  }
  finally {
    IOUtils.closeQuietly(output);
    IOUtils.closeQuietly(input);
  }
}
