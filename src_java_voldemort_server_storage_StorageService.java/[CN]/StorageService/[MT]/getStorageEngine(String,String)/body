{
  StorageConfiguration config=storageConfigs.get(type);
  if (config == null)   throw new ConfigurationException("Attempt to open store " + name + " but "+ type+ " storage engine of type "+ type+ " has not been enabled.");
  if (type.compareTo(ReadOnlyStorageConfiguration.TYPE_NAME) == 0) {
    final RoutingStrategy routingStrategy=new RoutingStrategyFactory().updateRoutingStrategy(metadata.getStoreDef(name),metadata.getCluster());
    ((ReadOnlyStorageConfiguration)config).setRoutingStrategy(routingStrategy);
  }
  final StorageEngine<ByteArray,byte[]> storageEngine=config.getStore(name);
  if (type.compareTo(ReadOnlyStorageConfiguration.TYPE_NAME) == 0) {
    metadata.addMetadataStoreListener(name,new MetadataStoreListener(){
      public void updateRoutingStrategy(      RoutingStrategy updatedRoutingStrategy){
        ((ReadOnlyStorageEngine)storageEngine).setRoutingStrategy(updatedRoutingStrategy);
      }
    }
);
  }
  return storageEngine;
}
