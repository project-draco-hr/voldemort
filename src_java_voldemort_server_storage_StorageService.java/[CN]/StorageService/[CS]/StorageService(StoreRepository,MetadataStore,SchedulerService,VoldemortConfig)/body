{
  super(ServiceType.STORAGE);
  this.voldemortConfig=config;
  this.scheduler=scheduler;
  this.storeRepository=storeRepository;
  this.metadata=metadata;
  this.scanPermitWrapper=new ScanPermitWrapper(voldemortConfig.getNumScanPermits());
  this.storageConfigs=new ConcurrentHashMap<String,StorageConfiguration>();
  this.clientThreadPool=new ClientThreadPool(config.getClientMaxThreads(),config.getClientThreadIdleMs(),config.getClientMaxQueuedRequests());
  this.storeFactory=new ClientRequestExecutorPool(config.getClientSelectors(),config.getClientMaxConnectionsPerNode(),config.getClientConnectionTimeoutMs(),config.getSocketTimeoutMs(),config.getSocketBufferSize(),config.getSocketKeepAlive());
  FailureDetectorConfig failureDetectorConfig=new FailureDetectorConfig(voldemortConfig).setCluster(metadata.getCluster()).setStoreVerifier(new ServerStoreVerifier(storeFactory,metadata,config));
  this.failureDetector=create(failureDetectorConfig,config.isJmxEnabled());
  this.storeStats=new StoreStats();
  this.routedStoreFactory=new RoutedStoreFactory(new RoutedStoreConfig(voldemortConfig));
  this.routedStoreFactory.setThreadPool(this.clientThreadPool);
  if (this.voldemortConfig.getStorageConfigurations().contains(ReadOnlyStorageConfiguration.class.getName())) {
    long rate=this.voldemortConfig.getReadOnlyFetcherMaxBytesPerSecond();
    this.dynThrottleLimit=new DynamicThrottleLimit(rate);
  }
 else   this.dynThrottleLimit=null;
  this.proxyPutWorkerPool=Executors.newFixedThreadPool(config.getMaxProxyPutThreads(),new DaemonThreadFactory("voldemort-proxy-put-thread"));
  this.aggregatedProxyPutStats=new ProxyPutStats(null);
  if (config.isJmxEnabled()) {
    JmxUtils.registerMbean(this.aggregatedProxyPutStats,JmxUtils.createObjectName("voldemort.store.rebalancing","aggregate-proxy-puts"));
  }
}
