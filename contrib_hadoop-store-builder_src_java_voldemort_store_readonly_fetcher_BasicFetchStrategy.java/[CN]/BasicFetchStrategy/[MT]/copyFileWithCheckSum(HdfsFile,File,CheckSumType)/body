{
  CheckSum fileCheckSumGenerator=null;
  logger.debug("Starting copy of " + source + " to "+ dest);
  boolean isCompressed=source.isCompressed();
  FilterInputStream input=null;
  OutputStream output=null;
  long startTimeMS=System.currentTimeMillis();
  for (int attempt=0; attempt < fetcher.getMaxAttempts(); attempt++) {
    boolean success=true;
    long totalBytesRead=0;
    boolean fsOpened=false;
    try {
      if (checkSumType != null) {
        fileCheckSumGenerator=CheckSum.getInstance(checkSumType);
      }
      logger.info("Attempt " + attempt + " at copy of "+ source+ " to "+ dest);
      if (!isCompressed) {
        input=fs.open(source.getPath());
      }
 else {
        input=new GZIPInputStream(fs.open(source.getPath()),this.bufferSize);
      }
      fsOpened=true;
      output=new BufferedOutputStream(new FileOutputStream(dest));
      while (true) {
        int read=input.read(buffer);
        if (read < 0) {
          break;
        }
 else {
          output.write(buffer,0,read);
        }
        if (fileCheckSumGenerator != null) {
          fileCheckSumGenerator.update(buffer,0,read);
        }
        if (fetcher.getThrottler() != null) {
          fetcher.getThrottler().maybeThrottle(read);
        }
        stats.recordBytes(read);
        totalBytesRead+=read;
        if (stats.getBytesSinceLastReport() > fetcher.getReportingIntervalBytes()) {
          NumberFormat format=NumberFormat.getNumberInstance();
          format.setMaximumFractionDigits(2);
          logger.info(stats.getTotalBytesCopied() / (1024 * 1024) + " MB copied at " + format.format(stats.getBytesPerSecond() / (1024 * 1024)) + " MB/sec - " + format.format(stats.getPercentCopied()) + " % complete, destination:" + dest);
          if (this.status != null) {
            this.status.setStatus(stats.getTotalBytesCopied() / (1024 * 1024) + " MB copied at " + format.format(stats.getBytesPerSecond() / (1024 * 1024)) + " MB/sec - " + format.format(stats.getPercentCopied()) + " % complete, destination:" + dest);
          }
          stats.reset();
        }
      }
      stats.reportFileDownloaded(dest,startTimeMS,source.getSize(),System.currentTimeMillis() - startTimeMS,attempt,totalBytesRead);
      logger.info("Completed copy of " + source + " to "+ dest);
    }
 catch (    Throwable te) {
      success=false;
      if (!fsOpened) {
        logger.error("Error while opening the file stream to " + source,te);
      }
 else {
        logger.error("Error while copying file " + source + " after "+ totalBytesRead+ " bytes.",te);
      }
      if (te.getCause() != null) {
        logger.error("Cause of error ",te.getCause());
      }
      if (attempt < fetcher.getMaxAttempts() - 1) {
        logger.info("Will retry copying after " + fetcher.getRetryDelayMs() + " ms");
        sleepForRetryDelayMs();
      }
 else {
        stats.reportFileError(dest,fetcher.getMaxAttempts(),startTimeMS,te);
        logger.info("Fetcher giving up copy after " + fetcher.getMaxAttempts() + " attempts");
        throw te;
      }
    }
 finally {
      IOUtils.closeQuietly(output);
      IOUtils.closeQuietly(input);
      if (success) {
        break;
      }
    }
    logger.debug("Completed copy of " + source + " to "+ dest);
  }
  return fileCheckSumGenerator;
}
