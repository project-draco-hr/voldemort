{
  checkNotClosed();
  long startNs=System.nanoTime();
  Pool<V> resourcePool=getResourcePoolForKey(key);
  attemptGrow(key,resourcePool);
  V resource=null;
  try {
    checkNotClosed();
    resource=attemptCheckout(resourcePool);
    if (resource == null) {
      long timeRemainingNs=resourcePoolConfig.getTimeout(TimeUnit.NANOSECONDS) - (System.nanoTime() - startNs);
      if (timeRemainingNs > 0)       resource=resourcePool.blockingGet(timeRemainingNs,System.currentTimeMillis());
      if (resource == null)       throw new TimeoutException("Could not acquire resource in " + resourcePoolConfig.getTimeout(TimeUnit.MILLISECONDS) + " ms.");
    }
    if (!objectFactory.validate(key,resource))     throw new ExcessiveInvalidResourcesException(1);
  }
 catch (  Exception e) {
    destroyResource(key,resourcePool,resource);
    throw e;
  }
  return resource;
}
